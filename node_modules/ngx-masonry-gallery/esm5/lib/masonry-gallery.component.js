/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { Component, EventEmitter, Input, Output, Renderer2, ChangeDetectionStrategy, } from '@angular/core';
import imagesLoadedMethod from 'imagesloaded';
import * as masonry from 'masonry-layout';
import { utilities } from './utilities';
import * as ɵngcc0 from '@angular/core';

const _c0 = [3, "id"];
var MasonryGalleryComponent = /** @class */ (function () {
    function MasonryGalleryComponent(renderer) {
        this.renderer = renderer;
        this.images = [];
        this.width = 330;
        this.gutter = 5;
        this.verticalGutter = 5;
        this.imageClasses = [];
        this.clickImage = new EventEmitter();
        this.removeComplete = new EventEmitter();
        this.layoutComplete = new EventEmitter();
        this.galleryGuid = utilities.newGuid();
        this.mansonryItemSelectorClass = "grid-item-" + this.galleryGuid;
        this.activeImages = [];
        this.viewReady = false;
    }
    /**
     * @param {?} changes
     * @return {?}
     */
    MasonryGalleryComponent.prototype.ngOnChanges = /**
     * @param {?} changes
     * @return {?}
     */
    function (changes) {
        if (changes.images && changes.images.currentValue) {
            if (!this.viewReady) {
                // process images once we can
                this.changesToProcess = changes;
            }
            else {
                this.processImages(changes);
            }
        }
    };
    /**
     * @return {?}
     */
    MasonryGalleryComponent.prototype.ngOnDestroy = /**
     * @return {?}
     */
    function () {
        if (this.msnry) {
            this.msnry.destroy();
        }
    };
    /**
     * @param {?} image
     * @return {?}
     */
    MasonryGalleryComponent.prototype.handleClick = /**
     * @param {?} image
     * @return {?}
     */
    function (image) {
        this.clickImage.next(image);
    };
    /**
     * @return {?}
     */
    MasonryGalleryComponent.prototype.ngAfterViewInit = /**
     * @return {?}
     */
    function () {
        this.viewReady = true;
        this.initMasonry();
        // process images now
        if (this.changesToProcess) {
            this.processImages(this.changesToProcess);
            this.changesToProcess = undefined;
        }
    };
    /**
     * @param {?} images
     * @return {?}
     */
    MasonryGalleryComponent.prototype.addImages = /**
     * @param {?} images
     * @return {?}
     */
    function (images) {
        if (images && images.length > 0) {
            this.addImagesToGallery(images);
        }
    };
    /**
     * @param {?} images
     * @return {?}
     */
    MasonryGalleryComponent.prototype.removeImages = /**
     * @param {?} images
     * @return {?}
     */
    function (images) {
        var _this = this;
        if (images && images.length > 0) {
            images.forEach((/**
             * @param {?} image
             * @return {?}
             */
            function (image) {
                _this.removeImageFromGallery(image);
            }));
        }
    };
    /**
     * @private
     * @param {?} changes
     * @return {?}
     */
    MasonryGalleryComponent.prototype.processImages = /**
     * @private
     * @param {?} changes
     * @return {?}
     */
    function (changes) {
        /** @type {?} */
        var imagesToProcess = this.getAddedAndRemovesImages(changes);
        // add images to mansonry layout
        this.addImages(imagesToProcess.addedImages);
        // removes images from layout
        this.removeImages(imagesToProcess.removedImages);
    };
    /**
     * @private
     * @param {?} changes
     * @return {?}
     */
    MasonryGalleryComponent.prototype.getAddedAndRemovesImages = /**
     * @private
     * @param {?} changes
     * @return {?}
     */
    function (changes) {
        /** @type {?} */
        var addedImages = [];
        /** @type {?} */
        var removedImages = [];
        /** @type {?} */
        var newImagesValue = (/** @type {?} */ (changes.images
            .currentValue));
        /** @type {?} */
        var oldImagesValue = (/** @type {?} */ (changes.images
            .previousValue));
        if (!oldImagesValue) {
            // all images are new ones
            addedImages = changes.images.currentValue;
        }
        else {
            // process added images
            newImagesValue.forEach((/**
             * @param {?} newImage
             * @return {?}
             */
            function (newImage) {
                /** @type {?} */
                var existingImage = oldImagesValue.find((/**
                 * @param {?} m
                 * @return {?}
                 */
                function (m) { return m.imageUrl.toLowerCase() === newImage.imageUrl.toLowerCase(); }));
                if (existingImage) {
                    // image was in previous value && is in new, do nothing
                }
                else {
                    // image is new
                    addedImages.push(newImage);
                }
            }));
            // process removed images
            oldImagesValue.forEach((/**
             * @param {?} oldImage
             * @return {?}
             */
            function (oldImage) {
                /** @type {?} */
                var existingImage = newImagesValue.find((/**
                 * @param {?} m
                 * @return {?}
                 */
                function (m) { return m.imageUrl.toLowerCase() === oldImage.imageUrl.toLowerCase(); }));
                if (existingImage) {
                    // image was in previous value && is in new, do nothing
                }
                else {
                    // image is removed
                    removedImages.push(oldImage);
                }
            }));
        }
        return {
            addedImages: addedImages,
            removedImages: removedImages
        };
    };
    /**
     * @private
     * @return {?}
     */
    MasonryGalleryComponent.prototype.initMasonry = /**
     * @private
     * @return {?}
     */
    function () {
        this.grid = document.getElementById(this.galleryGuid);
        // remove all existing data from grid
        this.grid.innerHTML = '';
        if (!this.grid) {
            throw Error("Could not init mansory due to non existing elem with id '" + this.galleryGuid + "'");
        }
        this.msnry = new masonry(this.grid, {
            // options...
            itemSelector: '.' + this.mansonryItemSelectorClass,
            columnWidth: this.width,
            gutter: this.gutter,
        });
        /** @type {?} */
        var that = this;
        this.msnry.on('layoutComplete', (/**
         * @param {?} items
         * @return {?}
         */
        function (items) {
            that.layoutComplete.next(items);
        }));
        this.msnry.on('removeComplete', (/**
         * @param {?} items
         * @return {?}
         */
        function (items) {
            that.removeComplete.next(items);
        }));
    };
    /**
     * @private
     * @param {?} image
     * @return {?}
     */
    MasonryGalleryComponent.prototype.removeImageFromGallery = /**
     * @private
     * @param {?} image
     * @return {?}
     */
    function (image) {
        // get image guid
        /** @type {?} */
        var imageIdResult = this.activeImages.find((/**
         * @param {?} m
         * @return {?}
         */
        function (m) { return m.image.imageUrl.toLowerCase() === image.imageUrl.toLowerCase(); }));
        if (!imageIdResult) {
            // image was not found, this is probably an error
            console.warn("Image with url '" + image.imageUrl + "' was not found. If you are adding images, make sure to 'replace' the images array with a new one\n                so that detection change can be executed instead of just adding an image to array\n                (which doesn't fire change detection on array property)");
            return;
        }
        // find image based on its id
        /** @type {?} */
        var imageElem = document.getElementById(imageIdResult.id);
        if (!imageElem) {
            // image was not found in DOM
            console.warn("Image with id '{" + imageIdResult.id + "}' was not found in DOM. Have you manipulated the DOM in some way?");
            return;
        }
        // remove image from gallery
        this.msnry.remove(imageElem);
        // refresh layout
        this.msnry.layout();
        // remove image from array
        for (var i = 0; i < this.activeImages.length; i++) {
            /** @type {?} */
            var idWithImage = this.activeImages[i];
            if (idWithImage.image.imageUrl.toLowerCase() ===
                imageIdResult.image.imageUrl.toLowerCase()) {
                this.activeImages.splice(i, 1);
            }
        }
    };
    /**
     * @private
     * @param {?} images
     * @return {?}
     */
    MasonryGalleryComponent.prototype.addImagesToGallery = /**
     * @private
     * @param {?} images
     * @return {?}
     */
    function (images) {
        var _this = this;
        if (!this.grid) {
            throw Error('Grid element is not yet ready, are you trying to add image too soon?');
        }
        /** @type {?} */
        var imagesWrapper = this.renderer.createElement('span');
        images.forEach((/**
         * @param {?} image
         * @return {?}
         */
        function (image) {
            // generate unique image id
            /** @type {?} */
            var imageId = _this.getImageId();
            // create element
            /** @type {?} */
            var imageElem = _this.renderer.createElement('img');
            imageElem.setAttribute('id', imageId);
            imageElem.setAttribute('alt', image.alt ? image.alt : 'no description');
            imageElem.setAttribute('src', image.imageUrl);
            // note - images are hidden by default and should be shown only after they are loaded
            imageElem.setAttribute('style', "display: none; width: " + _this.width + "px; margin-bottom: " + _this.verticalGutter + "px");
            imageElem.className = _this.getImageClass();
            imageElem.addEventListener('click', (/**
             * @return {?}
             */
            function () {
                _this.handleClick(image);
            }));
            // store guid with this image
            _this.activeImages.push({
                id: imageId,
                image: image
            });
            // add to dom and mansory & refresh layout
            _this.renderer.appendChild(imagesWrapper, imageElem);
        }));
        // add html to dom
        this.renderer.appendChild(this.grid, imagesWrapper);
        // add images once they are loaded
        /** @type {?} */
        var imgLoad = imagesLoadedMethod(imagesWrapper);
        imgLoad.on('progress', (/**
         * @param {?} instance
         * @param {?} image
         * @return {?}
         */
        function (instance, image) {
            if (image.isLoaded) {
                _this.renderer.appendChild(_this.grid, image.img);
                // unhide image
                _this.renderer.setStyle(image.img, 'display', 'block');
                _this.msnry.appended(image.img);
                _this.msnry.reloadItems();
            }
        }));
    };
    /**
     * @private
     * @return {?}
     */
    MasonryGalleryComponent.prototype.getImageClass = /**
     * @private
     * @return {?}
     */
    function () {
        /** @type {?} */
        var className = this.mansonryItemSelectorClass;
        if (this.imageClasses && this.imageClasses.length > 0) {
            /** @type {?} */
            var customClass = this.imageClasses.join(' ');
            className += ' ' + customClass;
        }
        return className;
    };
    /**
     * @private
     * @return {?}
     */
    MasonryGalleryComponent.prototype.getImageId = /**
     * @private
     * @return {?}
     */
    function () {
        return this.galleryGuid + '_' + utilities.newGuid();
    };
    /** @nocollapse */
    MasonryGalleryComponent.ctorParameters = function () { return [
        { type: Renderer2 }
    ]; };
    MasonryGalleryComponent.propDecorators = {
        images: [{ type: Input }],
        width: [{ type: Input }],
        gutter: [{ type: Input }],
        verticalGutter: [{ type: Input }],
        imageClasses: [{ type: Input }],
        clickImage: [{ type: Output }],
        removeComplete: [{ type: Output }],
        layoutComplete: [{ type: Output }]
    };
MasonryGalleryComponent.ngComponentDef = ɵngcc0.ɵɵdefineComponent({ type: MasonryGalleryComponent, selectors: [["ngx-masonry-gallery"]], factory: function MasonryGalleryComponent_Factory(t) { return new (t || MasonryGalleryComponent)(ɵngcc0.ɵɵdirectiveInject(Renderer2)); }, inputs: { images: "images", width: "width", gutter: "gutter", verticalGutter: "verticalGutter", imageClasses: "imageClasses" }, outputs: { clickImage: "clickImage", removeComplete: "removeComplete", layoutComplete: "layoutComplete" }, features: [ɵngcc0.ɵɵNgOnChangesFeature()], consts: 1, vars: 1, template: function MasonryGalleryComponent_Template(rf, ctx) { if (rf & 1) {
        ɵngcc0.ɵɵelement(0, "div", _c0);
    } if (rf & 2) {
        ɵngcc0.ɵɵproperty("id", ctx.galleryGuid);
    } }, encapsulation: 2, changeDetection: 0 });
/*@__PURE__*/ ɵngcc0.ɵsetClassMetadata(MasonryGalleryComponent, [{
        type: Component,
        args: [{
                changeDetection: ChangeDetectionStrategy.OnPush,
                selector: 'ngx-masonry-gallery',
                template: '<div [id]="galleryGuid"></div>'
            }]
    }], function () { return [{ type: Renderer2 }]; }, { renderer: [], images: [{
            type: Input
        }], width: [{
            type: Input
        }], gutter: [{
            type: Input
        }], verticalGutter: [{
            type: Input
        }], imageClasses: [{
            type: Input
        }], clickImage: [{
            type: Output
        }], removeComplete: [{
            type: Output
        }], layoutComplete: [{
            type: Output
        }], galleryGuid: [], mansonryItemSelectorClass: [], activeImages: [], viewReady: [], ngOnChanges: [], changesToProcess: [], ngOnDestroy: [], handleClick: [], ngAfterViewInit: [], addImages: [], removeImages: [], processImages: [], getAddedAndRemovesImages: [], initMasonry: [], grid: [], msnry: [], removeImageFromGallery: [], addImagesToGallery: [], getImageClass: [], getImageId: [] });
    return MasonryGalleryComponent;
}());
export { MasonryGalleryComponent };
if (false) {
    /** @type {?} */
    MasonryGalleryComponent.prototype.images;
    /** @type {?} */
    MasonryGalleryComponent.prototype.width;
    /** @type {?} */
    MasonryGalleryComponent.prototype.gutter;
    /** @type {?} */
    MasonryGalleryComponent.prototype.verticalGutter;
    /** @type {?} */
    MasonryGalleryComponent.prototype.imageClasses;
    /** @type {?} */
    MasonryGalleryComponent.prototype.clickImage;
    /** @type {?} */
    MasonryGalleryComponent.prototype.removeComplete;
    /** @type {?} */
    MasonryGalleryComponent.prototype.layoutComplete;
    /** @type {?} */
    MasonryGalleryComponent.prototype.galleryGuid;
    /**
     * @type {?}
     * @private
     */
    MasonryGalleryComponent.prototype.mansonryItemSelectorClass;
    /**
     * @type {?}
     * @private
     */
    MasonryGalleryComponent.prototype.activeImages;
    /**
     * @type {?}
     * @private
     */
    MasonryGalleryComponent.prototype.msnry;
    /**
     * @type {?}
     * @private
     */
    MasonryGalleryComponent.prototype.grid;
    /**
     * @type {?}
     * @private
     */
    MasonryGalleryComponent.prototype.changesToProcess;
    /**
     * @type {?}
     * @private
     */
    MasonryGalleryComponent.prototype.viewReady;
    /**
     * @type {?}
     * @private
     */
    MasonryGalleryComponent.prototype.renderer;
}
/**
 * @record
 */
function ActiveImage() { }
if (false) {
    /** @type {?} */
    ActiveImage.prototype.id;
    /** @type {?} */
    ActiveImage.prototype.image;
}

//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImM6L1VzZXJzL3R6aW9uL09uZURyaXZlL9ee16HXnteb15nXnS9Qcml2YXRlL0FydGljbGVTdGFjay1tYXN0ZXIvQXJ0aWNsZVN0YWNrLW1hc3Rlci9ub2RlX21vZHVsZXMvbmd4LW1hc29ucnktZ2FsbGVyeS9lc201L2xpYi9tYXNvbnJ5LWdhbGxlcnkuY29tcG9uZW50LmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBOzs7Ozs7Ozs7OztBQVFBOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztNQXNYTSxBQU9BOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OzRZQWNBIiwiZmlsZSI6Im1hc29ucnktZ2FsbGVyeS5jb21wb25lbnQuanMiLCJzb3VyY2VzQ29udGVudCI6WyIvKipcbiAqIEBmaWxlb3ZlcnZpZXcgYWRkZWQgYnkgdHNpY2tsZVxuICogQHN1cHByZXNzIHtjaGVja1R5cGVzLGV4dHJhUmVxdWlyZSxtaXNzaW5nT3ZlcnJpZGUsbWlzc2luZ1JldHVybix1bnVzZWRQcml2YXRlTWVtYmVycyx1c2VsZXNzQ29kZX0gY2hlY2tlZCBieSB0c2NcbiAqL1xuaW1wb3J0IHsgQ29tcG9uZW50LCBFdmVudEVtaXR0ZXIsIElucHV0LCBPdXRwdXQsIFJlbmRlcmVyMiwgQ2hhbmdlRGV0ZWN0aW9uU3RyYXRlZ3ksIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgaW1hZ2VzTG9hZGVkTWV0aG9kIGZyb20gJ2ltYWdlc2xvYWRlZCc7XG5pbXBvcnQgKiBhcyBtYXNvbnJ5IGZyb20gJ21hc29ucnktbGF5b3V0JztcbmltcG9ydCB7IHV0aWxpdGllcyB9IGZyb20gJy4vdXRpbGl0aWVzJztcbnZhciBNYXNvbnJ5R2FsbGVyeUNvbXBvbmVudCA9IC8qKiBAY2xhc3MgKi8gKGZ1bmN0aW9uICgpIHtcbiAgICBmdW5jdGlvbiBNYXNvbnJ5R2FsbGVyeUNvbXBvbmVudChyZW5kZXJlcikge1xuICAgICAgICB0aGlzLnJlbmRlcmVyID0gcmVuZGVyZXI7XG4gICAgICAgIHRoaXMuaW1hZ2VzID0gW107XG4gICAgICAgIHRoaXMud2lkdGggPSAzMzA7XG4gICAgICAgIHRoaXMuZ3V0dGVyID0gNTtcbiAgICAgICAgdGhpcy52ZXJ0aWNhbEd1dHRlciA9IDU7XG4gICAgICAgIHRoaXMuaW1hZ2VDbGFzc2VzID0gW107XG4gICAgICAgIHRoaXMuY2xpY2tJbWFnZSA9IG5ldyBFdmVudEVtaXR0ZXIoKTtcbiAgICAgICAgdGhpcy5yZW1vdmVDb21wbGV0ZSA9IG5ldyBFdmVudEVtaXR0ZXIoKTtcbiAgICAgICAgdGhpcy5sYXlvdXRDb21wbGV0ZSA9IG5ldyBFdmVudEVtaXR0ZXIoKTtcbiAgICAgICAgdGhpcy5nYWxsZXJ5R3VpZCA9IHV0aWxpdGllcy5uZXdHdWlkKCk7XG4gICAgICAgIHRoaXMubWFuc29ucnlJdGVtU2VsZWN0b3JDbGFzcyA9IFwiZ3JpZC1pdGVtLVwiICsgdGhpcy5nYWxsZXJ5R3VpZDtcbiAgICAgICAgdGhpcy5hY3RpdmVJbWFnZXMgPSBbXTtcbiAgICAgICAgdGhpcy52aWV3UmVhZHkgPSBmYWxzZTtcbiAgICB9XG4gICAgLyoqXG4gICAgICogQHBhcmFtIHs/fSBjaGFuZ2VzXG4gICAgICogQHJldHVybiB7P31cbiAgICAgKi9cbiAgICBNYXNvbnJ5R2FsbGVyeUNvbXBvbmVudC5wcm90b3R5cGUubmdPbkNoYW5nZXMgPSAvKipcbiAgICAgKiBAcGFyYW0gez99IGNoYW5nZXNcbiAgICAgKiBAcmV0dXJuIHs/fVxuICAgICAqL1xuICAgIGZ1bmN0aW9uIChjaGFuZ2VzKSB7XG4gICAgICAgIGlmIChjaGFuZ2VzLmltYWdlcyAmJiBjaGFuZ2VzLmltYWdlcy5jdXJyZW50VmFsdWUpIHtcbiAgICAgICAgICAgIGlmICghdGhpcy52aWV3UmVhZHkpIHtcbiAgICAgICAgICAgICAgICAvLyBwcm9jZXNzIGltYWdlcyBvbmNlIHdlIGNhblxuICAgICAgICAgICAgICAgIHRoaXMuY2hhbmdlc1RvUHJvY2VzcyA9IGNoYW5nZXM7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICB0aGlzLnByb2Nlc3NJbWFnZXMoY2hhbmdlcyk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9O1xuICAgIC8qKlxuICAgICAqIEByZXR1cm4gez99XG4gICAgICovXG4gICAgTWFzb25yeUdhbGxlcnlDb21wb25lbnQucHJvdG90eXBlLm5nT25EZXN0cm95ID0gLyoqXG4gICAgICogQHJldHVybiB7P31cbiAgICAgKi9cbiAgICBmdW5jdGlvbiAoKSB7XG4gICAgICAgIGlmICh0aGlzLm1zbnJ5KSB7XG4gICAgICAgICAgICB0aGlzLm1zbnJ5LmRlc3Ryb3koKTtcbiAgICAgICAgfVxuICAgIH07XG4gICAgLyoqXG4gICAgICogQHBhcmFtIHs/fSBpbWFnZVxuICAgICAqIEByZXR1cm4gez99XG4gICAgICovXG4gICAgTWFzb25yeUdhbGxlcnlDb21wb25lbnQucHJvdG90eXBlLmhhbmRsZUNsaWNrID0gLyoqXG4gICAgICogQHBhcmFtIHs/fSBpbWFnZVxuICAgICAqIEByZXR1cm4gez99XG4gICAgICovXG4gICAgZnVuY3Rpb24gKGltYWdlKSB7XG4gICAgICAgIHRoaXMuY2xpY2tJbWFnZS5uZXh0KGltYWdlKTtcbiAgICB9O1xuICAgIC8qKlxuICAgICAqIEByZXR1cm4gez99XG4gICAgICovXG4gICAgTWFzb25yeUdhbGxlcnlDb21wb25lbnQucHJvdG90eXBlLm5nQWZ0ZXJWaWV3SW5pdCA9IC8qKlxuICAgICAqIEByZXR1cm4gez99XG4gICAgICovXG4gICAgZnVuY3Rpb24gKCkge1xuICAgICAgICB0aGlzLnZpZXdSZWFkeSA9IHRydWU7XG4gICAgICAgIHRoaXMuaW5pdE1hc29ucnkoKTtcbiAgICAgICAgLy8gcHJvY2VzcyBpbWFnZXMgbm93XG4gICAgICAgIGlmICh0aGlzLmNoYW5nZXNUb1Byb2Nlc3MpIHtcbiAgICAgICAgICAgIHRoaXMucHJvY2Vzc0ltYWdlcyh0aGlzLmNoYW5nZXNUb1Byb2Nlc3MpO1xuICAgICAgICAgICAgdGhpcy5jaGFuZ2VzVG9Qcm9jZXNzID0gdW5kZWZpbmVkO1xuICAgICAgICB9XG4gICAgfTtcbiAgICAvKipcbiAgICAgKiBAcGFyYW0gez99IGltYWdlc1xuICAgICAqIEByZXR1cm4gez99XG4gICAgICovXG4gICAgTWFzb25yeUdhbGxlcnlDb21wb25lbnQucHJvdG90eXBlLmFkZEltYWdlcyA9IC8qKlxuICAgICAqIEBwYXJhbSB7P30gaW1hZ2VzXG4gICAgICogQHJldHVybiB7P31cbiAgICAgKi9cbiAgICBmdW5jdGlvbiAoaW1hZ2VzKSB7XG4gICAgICAgIGlmIChpbWFnZXMgJiYgaW1hZ2VzLmxlbmd0aCA+IDApIHtcbiAgICAgICAgICAgIHRoaXMuYWRkSW1hZ2VzVG9HYWxsZXJ5KGltYWdlcyk7XG4gICAgICAgIH1cbiAgICB9O1xuICAgIC8qKlxuICAgICAqIEBwYXJhbSB7P30gaW1hZ2VzXG4gICAgICogQHJldHVybiB7P31cbiAgICAgKi9cbiAgICBNYXNvbnJ5R2FsbGVyeUNvbXBvbmVudC5wcm90b3R5cGUucmVtb3ZlSW1hZ2VzID0gLyoqXG4gICAgICogQHBhcmFtIHs/fSBpbWFnZXNcbiAgICAgKiBAcmV0dXJuIHs/fVxuICAgICAqL1xuICAgIGZ1bmN0aW9uIChpbWFnZXMpIHtcbiAgICAgICAgdmFyIF90aGlzID0gdGhpcztcbiAgICAgICAgaWYgKGltYWdlcyAmJiBpbWFnZXMubGVuZ3RoID4gMCkge1xuICAgICAgICAgICAgaW1hZ2VzLmZvckVhY2goKC8qKlxuICAgICAgICAgICAgICogQHBhcmFtIHs/fSBpbWFnZVxuICAgICAgICAgICAgICogQHJldHVybiB7P31cbiAgICAgICAgICAgICAqL1xuICAgICAgICAgICAgZnVuY3Rpb24gKGltYWdlKSB7XG4gICAgICAgICAgICAgICAgX3RoaXMucmVtb3ZlSW1hZ2VGcm9tR2FsbGVyeShpbWFnZSk7XG4gICAgICAgICAgICB9KSk7XG4gICAgICAgIH1cbiAgICB9O1xuICAgIC8qKlxuICAgICAqIEBwcml2YXRlXG4gICAgICogQHBhcmFtIHs/fSBjaGFuZ2VzXG4gICAgICogQHJldHVybiB7P31cbiAgICAgKi9cbiAgICBNYXNvbnJ5R2FsbGVyeUNvbXBvbmVudC5wcm90b3R5cGUucHJvY2Vzc0ltYWdlcyA9IC8qKlxuICAgICAqIEBwcml2YXRlXG4gICAgICogQHBhcmFtIHs/fSBjaGFuZ2VzXG4gICAgICogQHJldHVybiB7P31cbiAgICAgKi9cbiAgICBmdW5jdGlvbiAoY2hhbmdlcykge1xuICAgICAgICAvKiogQHR5cGUgez99ICovXG4gICAgICAgIHZhciBpbWFnZXNUb1Byb2Nlc3MgPSB0aGlzLmdldEFkZGVkQW5kUmVtb3Zlc0ltYWdlcyhjaGFuZ2VzKTtcbiAgICAgICAgLy8gYWRkIGltYWdlcyB0byBtYW5zb25yeSBsYXlvdXRcbiAgICAgICAgdGhpcy5hZGRJbWFnZXMoaW1hZ2VzVG9Qcm9jZXNzLmFkZGVkSW1hZ2VzKTtcbiAgICAgICAgLy8gcmVtb3ZlcyBpbWFnZXMgZnJvbSBsYXlvdXRcbiAgICAgICAgdGhpcy5yZW1vdmVJbWFnZXMoaW1hZ2VzVG9Qcm9jZXNzLnJlbW92ZWRJbWFnZXMpO1xuICAgIH07XG4gICAgLyoqXG4gICAgICogQHByaXZhdGVcbiAgICAgKiBAcGFyYW0gez99IGNoYW5nZXNcbiAgICAgKiBAcmV0dXJuIHs/fVxuICAgICAqL1xuICAgIE1hc29ucnlHYWxsZXJ5Q29tcG9uZW50LnByb3RvdHlwZS5nZXRBZGRlZEFuZFJlbW92ZXNJbWFnZXMgPSAvKipcbiAgICAgKiBAcHJpdmF0ZVxuICAgICAqIEBwYXJhbSB7P30gY2hhbmdlc1xuICAgICAqIEByZXR1cm4gez99XG4gICAgICovXG4gICAgZnVuY3Rpb24gKGNoYW5nZXMpIHtcbiAgICAgICAgLyoqIEB0eXBlIHs/fSAqL1xuICAgICAgICB2YXIgYWRkZWRJbWFnZXMgPSBbXTtcbiAgICAgICAgLyoqIEB0eXBlIHs/fSAqL1xuICAgICAgICB2YXIgcmVtb3ZlZEltYWdlcyA9IFtdO1xuICAgICAgICAvKiogQHR5cGUgez99ICovXG4gICAgICAgIHZhciBuZXdJbWFnZXNWYWx1ZSA9ICgvKiogQHR5cGUgez99ICovIChjaGFuZ2VzLmltYWdlc1xuICAgICAgICAgICAgLmN1cnJlbnRWYWx1ZSkpO1xuICAgICAgICAvKiogQHR5cGUgez99ICovXG4gICAgICAgIHZhciBvbGRJbWFnZXNWYWx1ZSA9ICgvKiogQHR5cGUgez99ICovIChjaGFuZ2VzLmltYWdlc1xuICAgICAgICAgICAgLnByZXZpb3VzVmFsdWUpKTtcbiAgICAgICAgaWYgKCFvbGRJbWFnZXNWYWx1ZSkge1xuICAgICAgICAgICAgLy8gYWxsIGltYWdlcyBhcmUgbmV3IG9uZXNcbiAgICAgICAgICAgIGFkZGVkSW1hZ2VzID0gY2hhbmdlcy5pbWFnZXMuY3VycmVudFZhbHVlO1xuICAgICAgICB9XG4gICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgLy8gcHJvY2VzcyBhZGRlZCBpbWFnZXNcbiAgICAgICAgICAgIG5ld0ltYWdlc1ZhbHVlLmZvckVhY2goKC8qKlxuICAgICAgICAgICAgICogQHBhcmFtIHs/fSBuZXdJbWFnZVxuICAgICAgICAgICAgICogQHJldHVybiB7P31cbiAgICAgICAgICAgICAqL1xuICAgICAgICAgICAgZnVuY3Rpb24gKG5ld0ltYWdlKSB7XG4gICAgICAgICAgICAgICAgLyoqIEB0eXBlIHs/fSAqL1xuICAgICAgICAgICAgICAgIHZhciBleGlzdGluZ0ltYWdlID0gb2xkSW1hZ2VzVmFsdWUuZmluZCgoLyoqXG4gICAgICAgICAgICAgICAgICogQHBhcmFtIHs/fSBtXG4gICAgICAgICAgICAgICAgICogQHJldHVybiB7P31cbiAgICAgICAgICAgICAgICAgKi9cbiAgICAgICAgICAgICAgICBmdW5jdGlvbiAobSkgeyByZXR1cm4gbS5pbWFnZVVybC50b0xvd2VyQ2FzZSgpID09PSBuZXdJbWFnZS5pbWFnZVVybC50b0xvd2VyQ2FzZSgpOyB9KSk7XG4gICAgICAgICAgICAgICAgaWYgKGV4aXN0aW5nSW1hZ2UpIHtcbiAgICAgICAgICAgICAgICAgICAgLy8gaW1hZ2Ugd2FzIGluIHByZXZpb3VzIHZhbHVlICYmIGlzIGluIG5ldywgZG8gbm90aGluZ1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgLy8gaW1hZ2UgaXMgbmV3XG4gICAgICAgICAgICAgICAgICAgIGFkZGVkSW1hZ2VzLnB1c2gobmV3SW1hZ2UpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0pKTtcbiAgICAgICAgICAgIC8vIHByb2Nlc3MgcmVtb3ZlZCBpbWFnZXNcbiAgICAgICAgICAgIG9sZEltYWdlc1ZhbHVlLmZvckVhY2goKC8qKlxuICAgICAgICAgICAgICogQHBhcmFtIHs/fSBvbGRJbWFnZVxuICAgICAgICAgICAgICogQHJldHVybiB7P31cbiAgICAgICAgICAgICAqL1xuICAgICAgICAgICAgZnVuY3Rpb24gKG9sZEltYWdlKSB7XG4gICAgICAgICAgICAgICAgLyoqIEB0eXBlIHs/fSAqL1xuICAgICAgICAgICAgICAgIHZhciBleGlzdGluZ0ltYWdlID0gbmV3SW1hZ2VzVmFsdWUuZmluZCgoLyoqXG4gICAgICAgICAgICAgICAgICogQHBhcmFtIHs/fSBtXG4gICAgICAgICAgICAgICAgICogQHJldHVybiB7P31cbiAgICAgICAgICAgICAgICAgKi9cbiAgICAgICAgICAgICAgICBmdW5jdGlvbiAobSkgeyByZXR1cm4gbS5pbWFnZVVybC50b0xvd2VyQ2FzZSgpID09PSBvbGRJbWFnZS5pbWFnZVVybC50b0xvd2VyQ2FzZSgpOyB9KSk7XG4gICAgICAgICAgICAgICAgaWYgKGV4aXN0aW5nSW1hZ2UpIHtcbiAgICAgICAgICAgICAgICAgICAgLy8gaW1hZ2Ugd2FzIGluIHByZXZpb3VzIHZhbHVlICYmIGlzIGluIG5ldywgZG8gbm90aGluZ1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgLy8gaW1hZ2UgaXMgcmVtb3ZlZFxuICAgICAgICAgICAgICAgICAgICByZW1vdmVkSW1hZ2VzLnB1c2gob2xkSW1hZ2UpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0pKTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgYWRkZWRJbWFnZXM6IGFkZGVkSW1hZ2VzLFxuICAgICAgICAgICAgcmVtb3ZlZEltYWdlczogcmVtb3ZlZEltYWdlc1xuICAgICAgICB9O1xuICAgIH07XG4gICAgLyoqXG4gICAgICogQHByaXZhdGVcbiAgICAgKiBAcmV0dXJuIHs/fVxuICAgICAqL1xuICAgIE1hc29ucnlHYWxsZXJ5Q29tcG9uZW50LnByb3RvdHlwZS5pbml0TWFzb25yeSA9IC8qKlxuICAgICAqIEBwcml2YXRlXG4gICAgICogQHJldHVybiB7P31cbiAgICAgKi9cbiAgICBmdW5jdGlvbiAoKSB7XG4gICAgICAgIHRoaXMuZ3JpZCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKHRoaXMuZ2FsbGVyeUd1aWQpO1xuICAgICAgICAvLyByZW1vdmUgYWxsIGV4aXN0aW5nIGRhdGEgZnJvbSBncmlkXG4gICAgICAgIHRoaXMuZ3JpZC5pbm5lckhUTUwgPSAnJztcbiAgICAgICAgaWYgKCF0aGlzLmdyaWQpIHtcbiAgICAgICAgICAgIHRocm93IEVycm9yKFwiQ291bGQgbm90IGluaXQgbWFuc29yeSBkdWUgdG8gbm9uIGV4aXN0aW5nIGVsZW0gd2l0aCBpZCAnXCIgKyB0aGlzLmdhbGxlcnlHdWlkICsgXCInXCIpO1xuICAgICAgICB9XG4gICAgICAgIHRoaXMubXNucnkgPSBuZXcgbWFzb25yeSh0aGlzLmdyaWQsIHtcbiAgICAgICAgICAgIC8vIG9wdGlvbnMuLi5cbiAgICAgICAgICAgIGl0ZW1TZWxlY3RvcjogJy4nICsgdGhpcy5tYW5zb25yeUl0ZW1TZWxlY3RvckNsYXNzLFxuICAgICAgICAgICAgY29sdW1uV2lkdGg6IHRoaXMud2lkdGgsXG4gICAgICAgICAgICBndXR0ZXI6IHRoaXMuZ3V0dGVyLFxuICAgICAgICB9KTtcbiAgICAgICAgLyoqIEB0eXBlIHs/fSAqL1xuICAgICAgICB2YXIgdGhhdCA9IHRoaXM7XG4gICAgICAgIHRoaXMubXNucnkub24oJ2xheW91dENvbXBsZXRlJywgKC8qKlxuICAgICAgICAgKiBAcGFyYW0gez99IGl0ZW1zXG4gICAgICAgICAqIEByZXR1cm4gez99XG4gICAgICAgICAqL1xuICAgICAgICBmdW5jdGlvbiAoaXRlbXMpIHtcbiAgICAgICAgICAgIHRoYXQubGF5b3V0Q29tcGxldGUubmV4dChpdGVtcyk7XG4gICAgICAgIH0pKTtcbiAgICAgICAgdGhpcy5tc25yeS5vbigncmVtb3ZlQ29tcGxldGUnLCAoLyoqXG4gICAgICAgICAqIEBwYXJhbSB7P30gaXRlbXNcbiAgICAgICAgICogQHJldHVybiB7P31cbiAgICAgICAgICovXG4gICAgICAgIGZ1bmN0aW9uIChpdGVtcykge1xuICAgICAgICAgICAgdGhhdC5yZW1vdmVDb21wbGV0ZS5uZXh0KGl0ZW1zKTtcbiAgICAgICAgfSkpO1xuICAgIH07XG4gICAgLyoqXG4gICAgICogQHByaXZhdGVcbiAgICAgKiBAcGFyYW0gez99IGltYWdlXG4gICAgICogQHJldHVybiB7P31cbiAgICAgKi9cbiAgICBNYXNvbnJ5R2FsbGVyeUNvbXBvbmVudC5wcm90b3R5cGUucmVtb3ZlSW1hZ2VGcm9tR2FsbGVyeSA9IC8qKlxuICAgICAqIEBwcml2YXRlXG4gICAgICogQHBhcmFtIHs/fSBpbWFnZVxuICAgICAqIEByZXR1cm4gez99XG4gICAgICovXG4gICAgZnVuY3Rpb24gKGltYWdlKSB7XG4gICAgICAgIC8vIGdldCBpbWFnZSBndWlkXG4gICAgICAgIC8qKiBAdHlwZSB7P30gKi9cbiAgICAgICAgdmFyIGltYWdlSWRSZXN1bHQgPSB0aGlzLmFjdGl2ZUltYWdlcy5maW5kKCgvKipcbiAgICAgICAgICogQHBhcmFtIHs/fSBtXG4gICAgICAgICAqIEByZXR1cm4gez99XG4gICAgICAgICAqL1xuICAgICAgICBmdW5jdGlvbiAobSkgeyByZXR1cm4gbS5pbWFnZS5pbWFnZVVybC50b0xvd2VyQ2FzZSgpID09PSBpbWFnZS5pbWFnZVVybC50b0xvd2VyQ2FzZSgpOyB9KSk7XG4gICAgICAgIGlmICghaW1hZ2VJZFJlc3VsdCkge1xuICAgICAgICAgICAgLy8gaW1hZ2Ugd2FzIG5vdCBmb3VuZCwgdGhpcyBpcyBwcm9iYWJseSBhbiBlcnJvclxuICAgICAgICAgICAgY29uc29sZS53YXJuKFwiSW1hZ2Ugd2l0aCB1cmwgJ1wiICsgaW1hZ2UuaW1hZ2VVcmwgKyBcIicgd2FzIG5vdCBmb3VuZC4gSWYgeW91IGFyZSBhZGRpbmcgaW1hZ2VzLCBtYWtlIHN1cmUgdG8gJ3JlcGxhY2UnIHRoZSBpbWFnZXMgYXJyYXkgd2l0aCBhIG5ldyBvbmVcXG4gICAgICAgICAgICAgICAgc28gdGhhdCBkZXRlY3Rpb24gY2hhbmdlIGNhbiBiZSBleGVjdXRlZCBpbnN0ZWFkIG9mIGp1c3QgYWRkaW5nIGFuIGltYWdlIHRvIGFycmF5XFxuICAgICAgICAgICAgICAgICh3aGljaCBkb2Vzbid0IGZpcmUgY2hhbmdlIGRldGVjdGlvbiBvbiBhcnJheSBwcm9wZXJ0eSlcIik7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cbiAgICAgICAgLy8gZmluZCBpbWFnZSBiYXNlZCBvbiBpdHMgaWRcbiAgICAgICAgLyoqIEB0eXBlIHs/fSAqL1xuICAgICAgICB2YXIgaW1hZ2VFbGVtID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoaW1hZ2VJZFJlc3VsdC5pZCk7XG4gICAgICAgIGlmICghaW1hZ2VFbGVtKSB7XG4gICAgICAgICAgICAvLyBpbWFnZSB3YXMgbm90IGZvdW5kIGluIERPTVxuICAgICAgICAgICAgY29uc29sZS53YXJuKFwiSW1hZ2Ugd2l0aCBpZCAne1wiICsgaW1hZ2VJZFJlc3VsdC5pZCArIFwifScgd2FzIG5vdCBmb3VuZCBpbiBET00uIEhhdmUgeW91IG1hbmlwdWxhdGVkIHRoZSBET00gaW4gc29tZSB3YXk/XCIpO1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG4gICAgICAgIC8vIHJlbW92ZSBpbWFnZSBmcm9tIGdhbGxlcnlcbiAgICAgICAgdGhpcy5tc25yeS5yZW1vdmUoaW1hZ2VFbGVtKTtcbiAgICAgICAgLy8gcmVmcmVzaCBsYXlvdXRcbiAgICAgICAgdGhpcy5tc25yeS5sYXlvdXQoKTtcbiAgICAgICAgLy8gcmVtb3ZlIGltYWdlIGZyb20gYXJyYXlcbiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCB0aGlzLmFjdGl2ZUltYWdlcy5sZW5ndGg7IGkrKykge1xuICAgICAgICAgICAgLyoqIEB0eXBlIHs/fSAqL1xuICAgICAgICAgICAgdmFyIGlkV2l0aEltYWdlID0gdGhpcy5hY3RpdmVJbWFnZXNbaV07XG4gICAgICAgICAgICBpZiAoaWRXaXRoSW1hZ2UuaW1hZ2UuaW1hZ2VVcmwudG9Mb3dlckNhc2UoKSA9PT1cbiAgICAgICAgICAgICAgICBpbWFnZUlkUmVzdWx0LmltYWdlLmltYWdlVXJsLnRvTG93ZXJDYXNlKCkpIHtcbiAgICAgICAgICAgICAgICB0aGlzLmFjdGl2ZUltYWdlcy5zcGxpY2UoaSwgMSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9O1xuICAgIC8qKlxuICAgICAqIEBwcml2YXRlXG4gICAgICogQHBhcmFtIHs/fSBpbWFnZXNcbiAgICAgKiBAcmV0dXJuIHs/fVxuICAgICAqL1xuICAgIE1hc29ucnlHYWxsZXJ5Q29tcG9uZW50LnByb3RvdHlwZS5hZGRJbWFnZXNUb0dhbGxlcnkgPSAvKipcbiAgICAgKiBAcHJpdmF0ZVxuICAgICAqIEBwYXJhbSB7P30gaW1hZ2VzXG4gICAgICogQHJldHVybiB7P31cbiAgICAgKi9cbiAgICBmdW5jdGlvbiAoaW1hZ2VzKSB7XG4gICAgICAgIHZhciBfdGhpcyA9IHRoaXM7XG4gICAgICAgIGlmICghdGhpcy5ncmlkKSB7XG4gICAgICAgICAgICB0aHJvdyBFcnJvcignR3JpZCBlbGVtZW50IGlzIG5vdCB5ZXQgcmVhZHksIGFyZSB5b3UgdHJ5aW5nIHRvIGFkZCBpbWFnZSB0b28gc29vbj8nKTtcbiAgICAgICAgfVxuICAgICAgICAvKiogQHR5cGUgez99ICovXG4gICAgICAgIHZhciBpbWFnZXNXcmFwcGVyID0gdGhpcy5yZW5kZXJlci5jcmVhdGVFbGVtZW50KCdzcGFuJyk7XG4gICAgICAgIGltYWdlcy5mb3JFYWNoKCgvKipcbiAgICAgICAgICogQHBhcmFtIHs/fSBpbWFnZVxuICAgICAgICAgKiBAcmV0dXJuIHs/fVxuICAgICAgICAgKi9cbiAgICAgICAgZnVuY3Rpb24gKGltYWdlKSB7XG4gICAgICAgICAgICAvLyBnZW5lcmF0ZSB1bmlxdWUgaW1hZ2UgaWRcbiAgICAgICAgICAgIC8qKiBAdHlwZSB7P30gKi9cbiAgICAgICAgICAgIHZhciBpbWFnZUlkID0gX3RoaXMuZ2V0SW1hZ2VJZCgpO1xuICAgICAgICAgICAgLy8gY3JlYXRlIGVsZW1lbnRcbiAgICAgICAgICAgIC8qKiBAdHlwZSB7P30gKi9cbiAgICAgICAgICAgIHZhciBpbWFnZUVsZW0gPSBfdGhpcy5yZW5kZXJlci5jcmVhdGVFbGVtZW50KCdpbWcnKTtcbiAgICAgICAgICAgIGltYWdlRWxlbS5zZXRBdHRyaWJ1dGUoJ2lkJywgaW1hZ2VJZCk7XG4gICAgICAgICAgICBpbWFnZUVsZW0uc2V0QXR0cmlidXRlKCdhbHQnLCBpbWFnZS5hbHQgPyBpbWFnZS5hbHQgOiAnbm8gZGVzY3JpcHRpb24nKTtcbiAgICAgICAgICAgIGltYWdlRWxlbS5zZXRBdHRyaWJ1dGUoJ3NyYycsIGltYWdlLmltYWdlVXJsKTtcbiAgICAgICAgICAgIC8vIG5vdGUgLSBpbWFnZXMgYXJlIGhpZGRlbiBieSBkZWZhdWx0IGFuZCBzaG91bGQgYmUgc2hvd24gb25seSBhZnRlciB0aGV5IGFyZSBsb2FkZWRcbiAgICAgICAgICAgIGltYWdlRWxlbS5zZXRBdHRyaWJ1dGUoJ3N0eWxlJywgXCJkaXNwbGF5OiBub25lOyB3aWR0aDogXCIgKyBfdGhpcy53aWR0aCArIFwicHg7IG1hcmdpbi1ib3R0b206IFwiICsgX3RoaXMudmVydGljYWxHdXR0ZXIgKyBcInB4XCIpO1xuICAgICAgICAgICAgaW1hZ2VFbGVtLmNsYXNzTmFtZSA9IF90aGlzLmdldEltYWdlQ2xhc3MoKTtcbiAgICAgICAgICAgIGltYWdlRWxlbS5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsICgvKipcbiAgICAgICAgICAgICAqIEByZXR1cm4gez99XG4gICAgICAgICAgICAgKi9cbiAgICAgICAgICAgIGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgICAgICBfdGhpcy5oYW5kbGVDbGljayhpbWFnZSk7XG4gICAgICAgICAgICB9KSk7XG4gICAgICAgICAgICAvLyBzdG9yZSBndWlkIHdpdGggdGhpcyBpbWFnZVxuICAgICAgICAgICAgX3RoaXMuYWN0aXZlSW1hZ2VzLnB1c2goe1xuICAgICAgICAgICAgICAgIGlkOiBpbWFnZUlkLFxuICAgICAgICAgICAgICAgIGltYWdlOiBpbWFnZVxuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAvLyBhZGQgdG8gZG9tIGFuZCBtYW5zb3J5ICYgcmVmcmVzaCBsYXlvdXRcbiAgICAgICAgICAgIF90aGlzLnJlbmRlcmVyLmFwcGVuZENoaWxkKGltYWdlc1dyYXBwZXIsIGltYWdlRWxlbSk7XG4gICAgICAgIH0pKTtcbiAgICAgICAgLy8gYWRkIGh0bWwgdG8gZG9tXG4gICAgICAgIHRoaXMucmVuZGVyZXIuYXBwZW5kQ2hpbGQodGhpcy5ncmlkLCBpbWFnZXNXcmFwcGVyKTtcbiAgICAgICAgLy8gYWRkIGltYWdlcyBvbmNlIHRoZXkgYXJlIGxvYWRlZFxuICAgICAgICAvKiogQHR5cGUgez99ICovXG4gICAgICAgIHZhciBpbWdMb2FkID0gaW1hZ2VzTG9hZGVkTWV0aG9kKGltYWdlc1dyYXBwZXIpO1xuICAgICAgICBpbWdMb2FkLm9uKCdwcm9ncmVzcycsICgvKipcbiAgICAgICAgICogQHBhcmFtIHs/fSBpbnN0YW5jZVxuICAgICAgICAgKiBAcGFyYW0gez99IGltYWdlXG4gICAgICAgICAqIEByZXR1cm4gez99XG4gICAgICAgICAqL1xuICAgICAgICBmdW5jdGlvbiAoaW5zdGFuY2UsIGltYWdlKSB7XG4gICAgICAgICAgICBpZiAoaW1hZ2UuaXNMb2FkZWQpIHtcbiAgICAgICAgICAgICAgICBfdGhpcy5yZW5kZXJlci5hcHBlbmRDaGlsZChfdGhpcy5ncmlkLCBpbWFnZS5pbWcpO1xuICAgICAgICAgICAgICAgIC8vIHVuaGlkZSBpbWFnZVxuICAgICAgICAgICAgICAgIF90aGlzLnJlbmRlcmVyLnNldFN0eWxlKGltYWdlLmltZywgJ2Rpc3BsYXknLCAnYmxvY2snKTtcbiAgICAgICAgICAgICAgICBfdGhpcy5tc25yeS5hcHBlbmRlZChpbWFnZS5pbWcpO1xuICAgICAgICAgICAgICAgIF90aGlzLm1zbnJ5LnJlbG9hZEl0ZW1zKCk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pKTtcbiAgICB9O1xuICAgIC8qKlxuICAgICAqIEBwcml2YXRlXG4gICAgICogQHJldHVybiB7P31cbiAgICAgKi9cbiAgICBNYXNvbnJ5R2FsbGVyeUNvbXBvbmVudC5wcm90b3R5cGUuZ2V0SW1hZ2VDbGFzcyA9IC8qKlxuICAgICAqIEBwcml2YXRlXG4gICAgICogQHJldHVybiB7P31cbiAgICAgKi9cbiAgICBmdW5jdGlvbiAoKSB7XG4gICAgICAgIC8qKiBAdHlwZSB7P30gKi9cbiAgICAgICAgdmFyIGNsYXNzTmFtZSA9IHRoaXMubWFuc29ucnlJdGVtU2VsZWN0b3JDbGFzcztcbiAgICAgICAgaWYgKHRoaXMuaW1hZ2VDbGFzc2VzICYmIHRoaXMuaW1hZ2VDbGFzc2VzLmxlbmd0aCA+IDApIHtcbiAgICAgICAgICAgIC8qKiBAdHlwZSB7P30gKi9cbiAgICAgICAgICAgIHZhciBjdXN0b21DbGFzcyA9IHRoaXMuaW1hZ2VDbGFzc2VzLmpvaW4oJyAnKTtcbiAgICAgICAgICAgIGNsYXNzTmFtZSArPSAnICcgKyBjdXN0b21DbGFzcztcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gY2xhc3NOYW1lO1xuICAgIH07XG4gICAgLyoqXG4gICAgICogQHByaXZhdGVcbiAgICAgKiBAcmV0dXJuIHs/fVxuICAgICAqL1xuICAgIE1hc29ucnlHYWxsZXJ5Q29tcG9uZW50LnByb3RvdHlwZS5nZXRJbWFnZUlkID0gLyoqXG4gICAgICogQHByaXZhdGVcbiAgICAgKiBAcmV0dXJuIHs/fVxuICAgICAqL1xuICAgIGZ1bmN0aW9uICgpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuZ2FsbGVyeUd1aWQgKyAnXycgKyB1dGlsaXRpZXMubmV3R3VpZCgpO1xuICAgIH07XG4gICAgTWFzb25yeUdhbGxlcnlDb21wb25lbnQuZGVjb3JhdG9ycyA9IFtcbiAgICAgICAgeyB0eXBlOiBDb21wb25lbnQsIGFyZ3M6IFt7XG4gICAgICAgICAgICAgICAgICAgIGNoYW5nZURldGVjdGlvbjogQ2hhbmdlRGV0ZWN0aW9uU3RyYXRlZ3kuT25QdXNoLFxuICAgICAgICAgICAgICAgICAgICBzZWxlY3RvcjogJ25neC1tYXNvbnJ5LWdhbGxlcnknLFxuICAgICAgICAgICAgICAgICAgICB0ZW1wbGF0ZTogJzxkaXYgW2lkXT1cImdhbGxlcnlHdWlkXCI+PC9kaXY+J1xuICAgICAgICAgICAgICAgIH1dIH1cbiAgICBdO1xuICAgIC8qKiBAbm9jb2xsYXBzZSAqL1xuICAgIE1hc29ucnlHYWxsZXJ5Q29tcG9uZW50LmN0b3JQYXJhbWV0ZXJzID0gZnVuY3Rpb24gKCkgeyByZXR1cm4gW1xuICAgICAgICB7IHR5cGU6IFJlbmRlcmVyMiB9XG4gICAgXTsgfTtcbiAgICBNYXNvbnJ5R2FsbGVyeUNvbXBvbmVudC5wcm9wRGVjb3JhdG9ycyA9IHtcbiAgICAgICAgaW1hZ2VzOiBbeyB0eXBlOiBJbnB1dCB9XSxcbiAgICAgICAgd2lkdGg6IFt7IHR5cGU6IElucHV0IH1dLFxuICAgICAgICBndXR0ZXI6IFt7IHR5cGU6IElucHV0IH1dLFxuICAgICAgICB2ZXJ0aWNhbEd1dHRlcjogW3sgdHlwZTogSW5wdXQgfV0sXG4gICAgICAgIGltYWdlQ2xhc3NlczogW3sgdHlwZTogSW5wdXQgfV0sXG4gICAgICAgIGNsaWNrSW1hZ2U6IFt7IHR5cGU6IE91dHB1dCB9XSxcbiAgICAgICAgcmVtb3ZlQ29tcGxldGU6IFt7IHR5cGU6IE91dHB1dCB9XSxcbiAgICAgICAgbGF5b3V0Q29tcGxldGU6IFt7IHR5cGU6IE91dHB1dCB9XVxuICAgIH07XG4gICAgcmV0dXJuIE1hc29ucnlHYWxsZXJ5Q29tcG9uZW50O1xufSgpKTtcbmV4cG9ydCB7IE1hc29ucnlHYWxsZXJ5Q29tcG9uZW50IH07XG5pZiAoZmFsc2UpIHtcbiAgICAvKiogQHR5cGUgez99ICovXG4gICAgTWFzb25yeUdhbGxlcnlDb21wb25lbnQucHJvdG90eXBlLmltYWdlcztcbiAgICAvKiogQHR5cGUgez99ICovXG4gICAgTWFzb25yeUdhbGxlcnlDb21wb25lbnQucHJvdG90eXBlLndpZHRoO1xuICAgIC8qKiBAdHlwZSB7P30gKi9cbiAgICBNYXNvbnJ5R2FsbGVyeUNvbXBvbmVudC5wcm90b3R5cGUuZ3V0dGVyO1xuICAgIC8qKiBAdHlwZSB7P30gKi9cbiAgICBNYXNvbnJ5R2FsbGVyeUNvbXBvbmVudC5wcm90b3R5cGUudmVydGljYWxHdXR0ZXI7XG4gICAgLyoqIEB0eXBlIHs/fSAqL1xuICAgIE1hc29ucnlHYWxsZXJ5Q29tcG9uZW50LnByb3RvdHlwZS5pbWFnZUNsYXNzZXM7XG4gICAgLyoqIEB0eXBlIHs/fSAqL1xuICAgIE1hc29ucnlHYWxsZXJ5Q29tcG9uZW50LnByb3RvdHlwZS5jbGlja0ltYWdlO1xuICAgIC8qKiBAdHlwZSB7P30gKi9cbiAgICBNYXNvbnJ5R2FsbGVyeUNvbXBvbmVudC5wcm90b3R5cGUucmVtb3ZlQ29tcGxldGU7XG4gICAgLyoqIEB0eXBlIHs/fSAqL1xuICAgIE1hc29ucnlHYWxsZXJ5Q29tcG9uZW50LnByb3RvdHlwZS5sYXlvdXRDb21wbGV0ZTtcbiAgICAvKiogQHR5cGUgez99ICovXG4gICAgTWFzb25yeUdhbGxlcnlDb21wb25lbnQucHJvdG90eXBlLmdhbGxlcnlHdWlkO1xuICAgIC8qKlxuICAgICAqIEB0eXBlIHs/fVxuICAgICAqIEBwcml2YXRlXG4gICAgICovXG4gICAgTWFzb25yeUdhbGxlcnlDb21wb25lbnQucHJvdG90eXBlLm1hbnNvbnJ5SXRlbVNlbGVjdG9yQ2xhc3M7XG4gICAgLyoqXG4gICAgICogQHR5cGUgez99XG4gICAgICogQHByaXZhdGVcbiAgICAgKi9cbiAgICBNYXNvbnJ5R2FsbGVyeUNvbXBvbmVudC5wcm90b3R5cGUuYWN0aXZlSW1hZ2VzO1xuICAgIC8qKlxuICAgICAqIEB0eXBlIHs/fVxuICAgICAqIEBwcml2YXRlXG4gICAgICovXG4gICAgTWFzb25yeUdhbGxlcnlDb21wb25lbnQucHJvdG90eXBlLm1zbnJ5O1xuICAgIC8qKlxuICAgICAqIEB0eXBlIHs/fVxuICAgICAqIEBwcml2YXRlXG4gICAgICovXG4gICAgTWFzb25yeUdhbGxlcnlDb21wb25lbnQucHJvdG90eXBlLmdyaWQ7XG4gICAgLyoqXG4gICAgICogQHR5cGUgez99XG4gICAgICogQHByaXZhdGVcbiAgICAgKi9cbiAgICBNYXNvbnJ5R2FsbGVyeUNvbXBvbmVudC5wcm90b3R5cGUuY2hhbmdlc1RvUHJvY2VzcztcbiAgICAvKipcbiAgICAgKiBAdHlwZSB7P31cbiAgICAgKiBAcHJpdmF0ZVxuICAgICAqL1xuICAgIE1hc29ucnlHYWxsZXJ5Q29tcG9uZW50LnByb3RvdHlwZS52aWV3UmVhZHk7XG4gICAgLyoqXG4gICAgICogQHR5cGUgez99XG4gICAgICogQHByaXZhdGVcbiAgICAgKi9cbiAgICBNYXNvbnJ5R2FsbGVyeUNvbXBvbmVudC5wcm90b3R5cGUucmVuZGVyZXI7XG59XG4vKipcbiAqIEByZWNvcmRcbiAqL1xuZnVuY3Rpb24gQWN0aXZlSW1hZ2UoKSB7IH1cbmlmIChmYWxzZSkge1xuICAgIC8qKiBAdHlwZSB7P30gKi9cbiAgICBBY3RpdmVJbWFnZS5wcm90b3R5cGUuaWQ7XG4gICAgLyoqIEB0eXBlIHs/fSAqL1xuICAgIEFjdGl2ZUltYWdlLnByb3RvdHlwZS5pbWFnZTtcbn1cbiJdfQ==